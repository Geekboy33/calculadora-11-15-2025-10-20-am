<!DOCTYPE html>
<html>
<head>
    <title>Test Supabase Connection</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; background: #1a1a2e; color: #0f0; padding: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #16213e; border-radius: 3px; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #0a0; }
    </style>
</head>
<body>
    <h1>ðŸ”Œ Supabase Connection Test</h1>
    
    <div>
        <button onclick="testConnection()">1. Test Connection</button>
        <button onclick="testTables()">2. Check Tables</button>
        <button onclick="testInsert()">3. Test Insert Lock</button>
        <button onclick="testSelect()">4. Read Locks</button>
        <button onclick="testRealtime()">5. Test Realtime</button>
    </div>
    
    <h2>Output:</h2>
    <div id="output"></div>

    <script>
        const SUPABASE_URL = 'https://urczemskdstaqtvwbjlt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyY3plbXNrZHN0YXF0dndiamx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MTg5NDEsImV4cCI6MjA4NDk5NDk0MX0.n-twv_Vvkdg5Co26E1H-JeY8TEkTZtES9NTkdIjrZoA';
        
        let supabase = null;
        
        function log(msg, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }
        
        async function testConnection() {
            log('ðŸ”„ Testing Supabase connection...');
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log('âœ… Supabase client created successfully!', 'success');
                log('URL: ' + SUPABASE_URL);
                
                // Test basic query
                const { data, error } = await supabase.from('locks').select('count');
                
                if (error) {
                    if (error.code === '42P01') {
                        log('âš ï¸ Table "locks" does not exist! Run schema.sql in Supabase SQL Editor', 'warning');
                    } else {
                        log('âŒ Query error: ' + error.message, 'error');
                        log('Error code: ' + error.code, 'error');
                    }
                } else {
                    log('âœ… Connection successful! Tables exist.', 'success');
                }
            } catch (e) {
                log('âŒ Connection failed: ' + e.message, 'error');
            }
        }
        
        async function testTables() {
            if (!supabase) {
                log('âš ï¸ Run "Test Connection" first', 'warning');
                return;
            }
            
            log('ðŸ”„ Checking tables...');
            
            const tables = ['locks', 'mints', 'notifications', 'audit_log'];
            
            for (const table of tables) {
                const { data, error } = await supabase.from(table).select('id').limit(1);
                
                if (error) {
                    if (error.code === '42P01') {
                        log('âŒ Table "' + table + '" NOT FOUND', 'error');
                    } else {
                        log('âš ï¸ Table "' + table + '": ' + error.message, 'warning');
                    }
                } else {
                    log('âœ… Table "' + table + '" exists', 'success');
                }
            }
        }
        
        async function testInsert() {
            if (!supabase) {
                log('âš ï¸ Run "Test Connection" first', 'warning');
                return;
            }
            
            log('ðŸ”„ Testing INSERT into locks...');
            
            const testLock = {
                lock_id: 'TEST-' + Date.now(),
                amount_usd: 1000,
                beneficiary: '0xTestBeneficiary',
                bank_name: 'Test Bank',
                bank_account: 'TEST-123',
                status: 'pending',
                created_by: 'test-script',
                created_at: new Date().toISOString(),
                metadata: { test: true }
            };
            
            const { data, error } = await supabase.from('locks').insert(testLock).select();
            
            if (error) {
                log('âŒ INSERT failed: ' + error.message, 'error');
                log('Error details: ' + JSON.stringify(error), 'error');
            } else {
                log('âœ… INSERT successful!', 'success');
                log('Inserted: ' + JSON.stringify(data[0]), 'success');
            }
        }
        
        async function testSelect() {
            if (!supabase) {
                log('âš ï¸ Run "Test Connection" first', 'warning');
                return;
            }
            
            log('ðŸ”„ Reading locks...');
            
            const { data, error } = await supabase
                .from('locks')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (error) {
                log('âŒ SELECT failed: ' + error.message, 'error');
            } else {
                log('âœ… Found ' + data.length + ' locks:', 'success');
                data.forEach((lock, i) => {
                    log('  ' + (i+1) + '. ' + lock.lock_id + ' - $' + lock.amount_usd + ' - ' + lock.status);
                });
            }
        }
        
        async function testRealtime() {
            if (!supabase) {
                log('âš ï¸ Run "Test Connection" first', 'warning');
                return;
            }
            
            log('ðŸ”„ Setting up Realtime subscription...');
            
            const channel = supabase
                .channel('test-locks-channel')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'locks' },
                    (payload) => {
                        log('ðŸ“¡ REALTIME EVENT: ' + payload.eventType, 'success');
                        log('Data: ' + JSON.stringify(payload.new || payload.old), 'success');
                    }
                )
                .subscribe((status) => {
                    log('ðŸ“¡ Realtime status: ' + status, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    
                    if (status === 'SUBSCRIBED') {
                        log('âœ… Realtime is WORKING! Try inserting a new lock.', 'success');
                    }
                });
        }
        
        // Auto-run connection test
        window.onload = testConnection;
    </script>
</body>
</html>
