/**
 * DAES USD ALCHEMY Module
 * TokenizaciÃ³n y transferencia de USD en Ethereum Mainnet
 * Integrado con Alchemy RPC, ISO 20022, ISO 4217
 * Genera recibos PDF ultra profesionales con comprobante blockchain
 */

import { useState, useEffect, useCallback } from 'react';
import {
  Coins, Send, History, Server, RefreshCw, AlertCircle, CheckCircle,
  Download, ExternalLink, Copy, Wallet, Building2, Globe, Shield,
  Clock, Hash, FileText, Receipt, Lock, Zap, Database, Activity,
  Wifi, WifiOff, Info, Award
} from 'lucide-react';
import { useLanguage } from '../lib/i18n';
import { custodyStore, type CustodyAccount } from '../lib/custody-store';
import jsPDF from 'jspdf';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIPOS E INTERFACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MintOperation {
  id: string;
  type: 'mint' | 'send';
  amount: number;
  beneficiary?: string;
  toAddress?: string;
  fromWallet?: string;
  txHash: string;
  explorerUrl: string;
  status: 'PENDING' | 'COMPLETED' | 'FAILED';
  timestamp: number;
  blockNumber?: number;
  gasUsed?: string;
  memo?: string;
  custodyAccount?: CustodyAccount;
}

interface HealthStatus {
  success: boolean;
  chainId?: number;
  network?: string;
  blockNumber?: number;
  rpcUrl?: string;
  wsConnected?: boolean;
  masterWallet?: string;
  contracts?: {
    usdToken?: string;
    registry?: string;
    bridgeMinter?: string;
  };
  error?: string;
}

interface Stats {
  total: number;
  completed: number;
  pending: number;
  failed: number;
  totalMinted: number;
  totalTransfers?: number;
  totalTransferAmount?: number;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTE API ETH USD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const API_BASE = import.meta.env.VITE_ETH_USD_API_BASE || 'http://localhost:3000';

const ethUsdClient = {
  async getHealth(): Promise<HealthStatus> {
    try {
      const res = await fetch(`${API_BASE}/api/ethusd/health`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch (err: any) {
      return { success: false, error: err.message };
    }
  },

  async mintRequest(params: {
    amountUsd: number;
    beneficiary: string;
    custodyAccountId?: string;
    custodyAccountName?: string;
    idempotencyKey?: string;
  }) {
    const res = await fetch(`${API_BASE}/api/ethusd/mint-request`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });
    return await res.json();
  },

  async sendTokens(params: {
    amount: number;
    toAddress: string;
    fromWallet?: string;
    memo?: string;
  }) {
    const res = await fetch(`${API_BASE}/api/ethusd/send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });
    return await res.json();
  },

  /**
   * MINT-AND-SEND: Mintea tokens USD y los envÃ­a DIRECTAMENTE a la cuenta destino
   * Este es el flujo correcto para enviar USD tokenizado:
   * 1. Primero MINTEA los tokens (los crea en blockchain)
   * 2. Los tokens se envÃ­an DIRECTAMENTE al destinatario final
   * NO requiere que el operador tenga tokens previamente
   */
  async mintAndSend(params: {
    amount: number;
    toAddress: string;
    custodyAccountId?: string;
    custodyAccountName?: string;
    fromWallet?: string;
    memo?: string;
  }) {
    console.log('[DAES USD] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('[DAES USD] ğŸš€ MINT-AND-SEND OPERATION STARTED');
    console.log('[DAES USD] â”œâ”€â”€ Amount:', params.amount, 'USD');
    console.log('[DAES USD] â”œâ”€â”€ Destination:', params.toAddress);
    console.log('[DAES USD] â”œâ”€â”€ Custody Account:', params.custodyAccountName || params.custodyAccountId || 'default');
    console.log('[DAES USD] â””â”€â”€ Memo:', params.memo || 'none');
    console.log('[DAES USD] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    const res = await fetch(`${API_BASE}/api/ethusd/mint-and-send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params),
    });
    const result = await res.json();
    
    if (result.success) {
      console.log('[DAES USD] âœ… MINT-AND-SEND SUCCESS!');
      console.log('[DAES USD] â”œâ”€â”€ TX Hash:', result.txHash);
      console.log('[DAES USD] â””â”€â”€ Explorer:', result.explorerUrl);
    } else {
      console.error('[DAES USD] âŒ MINT-AND-SEND FAILED:', result.error);
    }
    
    return result;
  },

  async getStats(): Promise<Stats> {
    try {
      const res = await fetch(`${API_BASE}/api/ethusd/stats`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch {
      return { total: 0, completed: 0, pending: 0, failed: 0, totalMinted: 0 };
    }
  },

  async getHolds(): Promise<MintOperation[]> {
    try {
      const res = await fetch(`${API_BASE}/api/ethusd/holds`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return (data.holds || []).map((h: any) => ({ ...h, type: 'mint' }));
    } catch {
      return [];
    }
  },

  async getTransfers(): Promise<MintOperation[]> {
    try {
      const res = await fetch(`${API_BASE}/api/ethusd/transfers`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return (data.transfers || []).map((t: any) => ({ ...t, type: 'send' }));
    } catch {
      return [];
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECEIVERS PREDEFINIDOS (Wallets Destino Configurados)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface ReceiverConfig {
  id: string;
  name: string;
  address: string;
  company?: string;
  registrationNumber?: string;
  representative?: string;
  country?: string;
  description?: string;
  hostAddress?: string;
  hostIP?: string;
  rpcEndpoint?: string;
  wssEndpoint?: string;
  apiKey?: string;
}

const PREDEFINED_RECEIVERS: ReceiverConfig[] = [
  {
    id: 'sirichok-master-wallet',
    name: 'SIRICHOK PERMPOON CO., LTD. - Master Wallet',
    address: '0x1c01919cf117fb26b57554bc6bcec487e6831364',
    company: 'SIRICHOK PERMPOON CO., LTD.',
    registrationNumber: '0505558002277',
    representative: 'Mr. Zubko Viacheslav',
    country: 'Thailand (TH) / Ukraine (UKR)',
    description: '188/1447 Village No. 10, Sanmamen Sub-District, Sansai District, Chiang Mai Province, Thailand 50200',
    hostAddress: 'https://alchemy.com',
    hostIP: '161.35.181.101',
    rpcEndpoint: 'https://eth-mainnet.g.alchemy.com/v2/7iQ1gZ82J1A6Fig-QwHDb4_4GeoayYqj',
    wssEndpoint: 'wss://eth-mainnet.g.alchemy.com/v2/7iQ1gZ82J1A6Fig-QwHDb4_4GeoayYqj',
    apiKey: '7iQ1gZ82J1A6Fig-QwHDb4_4GeoayYqj'
  },
  {
    id: 'daes-treasury',
    name: 'DAES Treasury - Digital Commercial Bank Ltd',
    address: '0x05316B102FE62574b9cBd45709f8F1B6C00beC8a',
    company: 'Digital Commercial Bank Ltd',
    description: 'DAES Signer - Treasury Operations',
    hostAddress: 'https://alchemy.com',
    rpcEndpoint: 'https://eth-mainnet.g.alchemy.com/v2/7iQ1gZ82J1A6Fig-QwHDb4_4GeoayYqj'
  }
];

// COMPONENTE PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function DAESUsdAlchemyModule() {
  const { language } = useLanguage();
  const isSpanish = language === 'es';

  // Estados principales
  const [activeTab, setActiveTab] = useState<'mint' | 'send' | 'history' | 'config'>('mint');
  const [health, setHealth] = useState<HealthStatus | null>(null);
  const [stats, setStats] = useState<Stats>({ total: 0, completed: 0, pending: 0, failed: 0, totalMinted: 0 });
  const [operations, setOperations] = useState<MintOperation[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  // Cuentas custodio
  const [custodyAccounts, setCustodyAccounts] = useState<CustodyAccount[]>([]);
  const [selectedAccountId, setSelectedAccountId] = useState<string>('');

  // Formulario de mint
  const [mintAmount, setMintAmount] = useState<number>(0);
  const [beneficiaryWallet, setBeneficiaryWallet] = useState<string>('');

  // Formulario de send
  const [sendAmount, setSendAmount] = useState<number>(0);
  const [sendToAddress, setSendToAddress] = useState<string>('');
  const [sendMemo, setSendMemo] = useState<string>('');
  const [selectedReceiver, setSelectedReceiver] = useState<ReceiverConfig | null>(null);

  // Modal de recibo
  const [showReceiptModal, setShowReceiptModal] = useState(false);
  const [lastOperation, setLastOperation] = useState<MintOperation | null>(null);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CARGAR DATOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const loadHealth = useCallback(async () => {
    const h = await ethUsdClient.getHealth();
    setHealth(h);
  }, []);

  const loadStats = useCallback(async () => {
    const s = await ethUsdClient.getStats();
    setStats(s);
  }, []);

  const loadOperations = useCallback(async () => {
    const [holds, transfers] = await Promise.all([
      ethUsdClient.getHolds(),
      ethUsdClient.getTransfers(),
    ]);
    const combined = [...holds, ...transfers].sort((a, b) => b.timestamp - a.timestamp);
    setOperations(combined);
  }, []);

  const loadCustodyAccounts = useCallback(() => {
    const accounts = custodyStore.getAccounts().filter(a => a.currency === 'USD');
    setCustodyAccounts(accounts);
    if (accounts.length > 0 && !selectedAccountId) {
      setSelectedAccountId(accounts[0].id);
    }
  }, [selectedAccountId]);

  useEffect(() => {
    loadHealth();
    loadStats();
    loadOperations();
    loadCustodyAccounts();

    const interval = setInterval(() => {
      loadHealth();
      loadStats();
    }, 30000);

    return () => clearInterval(interval);
  }, [loadHealth, loadStats, loadOperations, loadCustodyAccounts]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GENERAR RECIBO PDF ULTRA PROFESIONAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const generateBlockchainReceiptPDF = async (operation: MintOperation) => {
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 10;
    let y = margin;
    const date = new Date(operation.timestamp);

    // Colores corporativos
    const colors = {
      darkBlue: [8, 20, 40] as [number, number, number],
      navy: [12, 30, 55] as [number, number, number],
      gold: [197, 165, 55] as [number, number, number],
      lightGold: [218, 190, 100] as [number, number, number],
      green: [22, 163, 74] as [number, number, number],
      emerald: [16, 185, 129] as [number, number, number],
      gray: [75, 85, 99] as [number, number, number],
      lightGray: [248, 250, 252] as [number, number, number],
      black: [0, 0, 0] as [number, number, number],
      white: [255, 255, 255] as [number, number, number],
      red: [220, 38, 38] as [number, number, number],
      purple: [139, 92, 246] as [number, number, number],
      cyan: [6, 182, 212] as [number, number, number],
    };

    // Identificadores Ãºnicos
    const receiptNumber = `DAES-ETH-${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random() * 999999).toString().padStart(6, '0')}`;
    const verificationCode = Array.from({ length: 32 }, () => Math.random().toString(16).charAt(2)).join('').toUpperCase();
    const daesValidationHash = Array.from({ length: 64 }, () => Math.random().toString(16).charAt(2)).join('').toUpperCase();

    // Datos de cuenta custodio
    const custodyAccount = custodyAccounts.find(a => a.id === selectedAccountId);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEADER INSTITUCIONAL PREMIUM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const drawInstitutionalHeader = () => {
      // Fondo principal del header
      pdf.setFillColor(...colors.darkBlue);
      pdf.rect(0, 0, pageWidth, 62, 'F');

      // LÃ­neas doradas decorativas superiores
      pdf.setFillColor(...colors.gold);
      pdf.rect(0, 0, pageWidth, 2, 'F');
      pdf.setFillColor(...colors.lightGold);
      pdf.rect(0, 2, pageWidth, 0.5, 'F');

      // Marco dorado interior
      pdf.setDrawColor(...colors.gold);
      pdf.setLineWidth(0.8);
      pdf.rect(8, 8, pageWidth - 16, 46, 'S');

      // PatrÃ³n de lÃ­neas decorativo inferior
      pdf.setDrawColor(...colors.gold);
      pdf.setLineWidth(0.2);
      for (let i = 0; i < pageWidth; i += 6) {
        pdf.line(i, 58, i + 3, 58);
      }

      // LÃ­nea dorada inferior del header
      pdf.setFillColor(...colors.gold);
      pdf.rect(0, 60, pageWidth, 2.5, 'F');

      // Nombre del banco
      pdf.setTextColor(...colors.white);
      pdf.setFontSize(24);
      pdf.setFont('helvetica', 'bold');
      pdf.text('DIGITAL COMMERCIAL BANK LTD', pageWidth / 2, 20, { align: 'center' });

      // Sistema DAES
      pdf.setFontSize(11);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.gold);
      pdf.text('DAES - Digital Asset & Electronic Services Platform', pageWidth / 2, 28, { align: 'center' });

      // URLs oficiales
      pdf.setFontSize(7);
      pdf.setTextColor(160, 170, 180);
      pdf.text('www.digcommbank.com    |    www.luxliqdaes.cloud', pageWidth / 2, 36, { align: 'center' });

      // TÃ­tulo del documento segÃºn tipo
      const title = operation.type === 'mint'
        ? (isSpanish ? 'COMPROBANTE DE TOKENIZACIÃ“N USD' : 'USD TOKENIZATION RECEIPT')
        : (isSpanish ? 'COMPROBANTE DE TRANSFERENCIA USD TOKENIZADO' : 'TOKENIZED USD TRANSFER RECEIPT');
      pdf.setFontSize(12);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...colors.white);
      pdf.text(title, pageWidth / 2, 46, { align: 'center' });

      // SubtÃ­tulo blockchain
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...colors.cyan);
      pdf.text('Ethereum Mainnet | Alchemy RPC | ERC-20 Token', pageWidth / 2, 52, { align: 'center' });

      y = 72;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FOOTER INSTITUCIONAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const drawInstitutionalFooter = () => {
      const footerY = pageHeight - 22;

      // Fondo del footer
      pdf.setFillColor(248, 250, 252);
      pdf.rect(0, footerY - 8, pageWidth, 30, 'F');

      // LÃ­nea dorada superior
      pdf.setFillColor(...colors.gold);
      pdf.rect(0, footerY - 8, pageWidth, 1.5, 'F');

      // InformaciÃ³n del banco
      pdf.setTextColor(...colors.gray);
      pdf.setFontSize(6);
      pdf.setFont('helvetica', 'normal');
      pdf.text('Digital Commercial Bank Ltd | ISO 27001:2022 Certified | ISO 20022 Native | PCI-DSS Level 1 | FATF AML/CFT Compliant', pageWidth / 2, footerY - 2, { align: 'center' });

      // Blockchain info
      pdf.setFontSize(5.5);
      pdf.setTextColor(...colors.purple);
      pdf.text('Ethereum Mainnet â€¢ Chain ID: 1 â€¢ Alchemy Infrastructure â€¢ EIP-712 Signatures', pageWidth / 2, footerY + 2, { align: 'center' });

      // URLs
      pdf.setTextColor(...colors.darkBlue);
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(6.5);
      pdf.text('https://digcommbank.com', margin, footerY + 7);
      pdf.text('https://etherscan.io', margin + 45, footerY + 7);

      // Fecha de generaciÃ³n
      const dateText = date.toLocaleDateString(isSpanish ? 'es-ES' : 'en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
      pdf.setTextColor(...colors.gray);
      pdf.setFont('helvetica', 'normal');
      pdf.text(dateText, pageWidth / 2, footerY + 7, { align: 'center' });

      // Confidencial
      pdf.setTextColor(...colors.red);
      pdf.setFontSize(5);
      pdf.setFont('helvetica', 'bold');
      pdf.text(isSpanish ? 'DOCUMENTO CONFIDENCIAL - BLOCKCHAIN VERIFIED' : 'CONFIDENTIAL DOCUMENT - BLOCKCHAIN VERIFIED', pageWidth - margin, footerY - 2, { align: 'right' });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIÃ“N PARA DIBUJAR SECCIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const drawSection = (title: string, sectionNum: number, bgColor: [number, number, number] = colors.darkBlue) => {
      pdf.setFillColor(...bgColor);
      pdf.rect(margin, y, pageWidth - (margin * 2), 8, 'F');

      // Borde dorado izquierdo
      pdf.setFillColor(...colors.gold);
      pdf.rect(margin, y, 2.5, 8, 'F');

      // NÃºmero de secciÃ³n
      pdf.setFillColor(...colors.gold);
      pdf.rect(margin + 4, y + 1, 12, 6, 'F');
      pdf.setTextColor(...colors.darkBlue);
      pdf.setFontSize(7);
      pdf.setFont('helvetica', 'bold');
      pdf.text(String(sectionNum).padStart(2, '0'), margin + 10, y + 5.2, { align: 'center' });

      pdf.setTextColor(...colors.white);
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.text(title, margin + 20, y + 5.5);

      y += 11;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIÃ“N PARA DIBUJAR TABLA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const drawTable = (data: [string, string][], startY: number): number => {
      const colWidth1 = 55;
      const colWidth2 = pageWidth - (margin * 2) - colWidth1;
      const rowHeight = 7;
      let currentY = startY;

      data.forEach((row, index) => {
        const bgColor = index % 2 === 0 ? colors.lightGray : colors.white;
        pdf.setFillColor(...bgColor);
        pdf.rect(margin, currentY, pageWidth - (margin * 2), rowHeight, 'F');

        // Borde
        pdf.setDrawColor(200, 200, 200);
        pdf.setLineWidth(0.1);
        pdf.rect(margin, currentY, colWidth1, rowHeight, 'S');
        pdf.rect(margin + colWidth1, currentY, colWidth2, rowHeight, 'S');

        // Label
        pdf.setTextColor(...colors.gray);
        pdf.setFontSize(7);
        pdf.setFont('helvetica', 'bold');
        pdf.text(row[0], margin + 2, currentY + 4.5);

        // Value
        pdf.setTextColor(...colors.black);
        pdf.setFont('helvetica', 'normal');
        // Truncar valores largos
        const maxWidth = colWidth2 - 4;
        let value = row[1];
        while (pdf.getTextWidth(value) > maxWidth && value.length > 10) {
          value = value.slice(0, -4) + '...';
        }
        pdf.text(value, margin + colWidth1 + 2, currentY + 4.5);

        currentY += rowHeight;
      });

      return currentY;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GENERAR CONTENIDO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    drawInstitutionalHeader();

    // SECCIÃ“N 01: INFORMACIÃ“N DEL COMPROBANTE
    drawSection(isSpanish ? 'INFORMACIÃ“N DEL COMPROBANTE' : 'RECEIPT INFORMATION', 1);
    y = drawTable([
      [isSpanish ? 'NÃºmero de Recibo' : 'Receipt Number', receiptNumber],
      [isSpanish ? 'Tipo de OperaciÃ³n' : 'Operation Type', operation.type === 'mint' ? 'TOKENIZATION (MINT)' : 'TRANSFER (SEND)'],
      [isSpanish ? 'Fecha de TransacciÃ³n' : 'Transaction Date', date.toLocaleDateString(isSpanish ? 'es-ES' : 'en-US')],
      [isSpanish ? 'Hora de TransacciÃ³n' : 'Transaction Time', date.toLocaleTimeString(isSpanish ? 'es-ES' : 'en-US')],
      [isSpanish ? 'Estado' : 'Status', operation.status === 'COMPLETED' ? 'âœ“ COMPLETED' : operation.status],
    ], y);
    y += 5;

    // SECCIÃ“N 02: CUENTA CUSTODIO ORIGEN
    drawSection(isSpanish ? 'CUENTA CUSTODIO ORIGEN' : 'SOURCE CUSTODY ACCOUNT', 2);
    const custodyData: [string, string][] = [
      [isSpanish ? 'Banco' : 'Bank', 'DIGITAL COMMERCIAL BANK LTD'],
      [isSpanish ? 'Sistema' : 'System', 'DAES CoreBanking Platform'],
    ];
    if (custodyAccount) {
      custodyData.push(
        [isSpanish ? 'Nombre de Cuenta' : 'Account Name', custodyAccount.accountName],
        [isSpanish ? 'NÃºmero de Cuenta' : 'Account Number', custodyAccount.accountNumber],
        [isSpanish ? 'Tipo de Cuenta' : 'Account Type', custodyAccount.accountCategory?.toUpperCase() || 'CUSTODY'],
        [isSpanish ? 'Divisa' : 'Currency', custodyAccount.currency],
      );
    } else {
      custodyData.push(
        [isSpanish ? 'Nombre de Cuenta' : 'Account Name', 'Treasury Reserve Account'],
        [isSpanish ? 'NÃºmero de Cuenta' : 'Account Number', 'DCB-USD-00000001'],
        [isSpanish ? 'Tipo de Cuenta' : 'Account Type', 'CUSTODY RESERVE'],
      );
    }
    y = drawTable(custodyData, y);
    y += 5;

    // SECCIÃ“N 03: MONTO TOKENIZADO / TRANSFERIDO
    drawSection(isSpanish ? 'MONTO DE LA OPERACIÃ“N' : 'OPERATION AMOUNT', 3);

    // Cuadro destacado para el monto
    pdf.setFillColor(...colors.darkBlue);
    pdf.rect(margin, y, pageWidth - (margin * 2), 22, 'F');
    pdf.setFillColor(...colors.gold);
    pdf.rect(margin, y, 3, 22, 'F');

    pdf.setTextColor(...colors.white);
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'normal');
    const amountLabel = operation.type === 'mint'
      ? (isSpanish ? 'MONTO TOTAL TOKENIZADO' : 'TOTAL AMOUNT TOKENIZED')
      : (isSpanish ? 'MONTO TOTAL TRANSFERIDO' : 'TOTAL AMOUNT TRANSFERRED');
    pdf.text(amountLabel, margin + 8, y + 5);

    pdf.setFontSize(22);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...colors.gold);
    pdf.text(`USD ${operation.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}`, margin + 8, y + 15);

    // ISO 4217
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.text('ISO 4217: 840 - United States Dollar', pageWidth - margin - 5, y + 8, { align: 'right' });
    pdf.text('ISO 20022: pain.001.001.09', pageWidth - margin - 5, y + 12, { align: 'right' });
    pdf.text('Token Standard: ERC-20', pageWidth - margin - 5, y + 16, { align: 'right' });

    y += 27;

    // SECCIÃ“N 04: INFORMACIÃ“N BLOCKCHAIN
    const blockchainColor: [number, number, number] = [20, 10, 50];
    drawSection(isSpanish ? 'INFORMACIÃ“N BLOCKCHAIN' : 'BLOCKCHAIN INFORMATION', 4, blockchainColor);
    y = drawTable([
      ['Network', 'Ethereum Mainnet'],
      ['Chain ID', '1'],
      ['RPC Provider', 'Alchemy (g.alchemy.com)'],
      ['Transaction Hash', operation.txHash || 'Pending...'],
      ['Block Number', operation.blockNumber?.toString() || 'Pending...'],
      ['Gas Used', operation.gasUsed || 'Standard'],
      ['Explorer URL', 'etherscan.io/tx/...'],
    ], y);
    y += 5;

    // SECCIÃ“N 05: DIRECCIONES
    drawSection(operation.type === 'mint' ? (isSpanish ? 'WALLET BENEFICIARIO' : 'BENEFICIARY WALLET') : (isSpanish ? 'DIRECCIÃ“N DESTINO' : 'DESTINATION ADDRESS'), 5);
    const addressData: [string, string][] = [];
    if (operation.type === 'mint' && operation.beneficiary) {
      addressData.push([isSpanish ? 'Wallet ETH Beneficiario' : 'Beneficiary ETH Wallet', operation.beneficiary]);
    }
    if (operation.type === 'send') {
      if (operation.fromWallet) addressData.push([isSpanish ? 'Wallet Origen' : 'Source Wallet', operation.fromWallet]);
      if (operation.toAddress) addressData.push([isSpanish ? 'Wallet Destino' : 'Destination Wallet', operation.toAddress]);
      if (operation.memo) addressData.push([isSpanish ? 'Memo/Referencia' : 'Memo/Reference', operation.memo]);
    }
    addressData.push(
      ['Token Contract', health?.contracts?.usdToken || '0x...'],
      ['Bridge Minter', health?.contracts?.bridgeMinter || '0x...'],
    );
    y = drawTable(addressData, y);
    y += 5;

    // SECCIÃ“N 06: VALIDACIÃ“N INTERNA DAES
    drawSection(isSpanish ? 'VALIDACIÃ“N INTERNA DAES' : 'DAES INTERNAL VALIDATION', 6);

    // Box de validaciÃ³n
    pdf.setFillColor(250, 252, 255);
    pdf.setDrawColor(...colors.gold);
    pdf.setLineWidth(0.5);
    pdf.rect(margin, y, pageWidth - (margin * 2), 32, 'FD');

    pdf.setTextColor(...colors.gray);
    pdf.setFontSize(6);
    pdf.setFont('helvetica', 'bold');
    pdf.text(isSpanish ? 'CÃ“DIGO DE VERIFICACIÃ“N DAES' : 'DAES VERIFICATION CODE', margin + 3, y + 5);
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(5.5);
    pdf.setTextColor(...colors.darkBlue);
    pdf.text(verificationCode, margin + 3, y + 9);

    pdf.setTextColor(...colors.gray);
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(6);
    pdf.text('DAES VALIDATION HASH (SHA-256)', margin + 3, y + 15);
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(4.5);
    pdf.setTextColor(...colors.darkBlue);
    pdf.text(daesValidationHash, margin + 3, y + 19);

    pdf.setTextColor(...colors.gray);
    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(6);
    pdf.text('BLOCKCHAIN TX HASH', margin + 3, y + 25);
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(4.5);
    pdf.setTextColor(...colors.purple);
    pdf.text(operation.txHash || 'Processing...', margin + 3, y + 29);

    // Sello de verificado
    if (operation.status === 'COMPLETED') {
      pdf.setFillColor(...colors.green);
      pdf.setTextColor(...colors.white);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'bold');
      const stampX = pageWidth - margin - 38;
      const stampY = y + 8;
      pdf.rect(stampX, stampY, 33, 18, 'F');
      pdf.text('âœ“ VERIFIED', stampX + 16.5, stampY + 8, { align: 'center' });
      pdf.setFontSize(5);
      pdf.text('BLOCKCHAIN', stampX + 16.5, stampY + 13, { align: 'center' });
    }

    y += 37;

    // SECCIÃ“N 07: ESTÃNDARES Y CUMPLIMIENTO
    drawSection(isSpanish ? 'ESTÃNDARES Y CUMPLIMIENTO' : 'STANDARDS & COMPLIANCE', 7);
    y = drawTable([
      ['ISO 20022', 'pain.001.001.09 - Customer Credit Transfer'],
      ['ISO 4217', '840 - USD (United States Dollar)'],
      ['ISO 27001', 'Information Security Management'],
      ['EIP-712', 'Typed Structured Data Hashing and Signing'],
      ['ERC-20', 'Token Standard Compliance'],
      ['AML/CFT', 'FATF Compliant'],
    ], y);
    y += 5;

    // DeclaraciÃ³n final
    pdf.setTextColor(...colors.gray);
    pdf.setFontSize(6.5);
    pdf.setFont('helvetica', 'italic');
    const declaration = isSpanish
      ? 'Este documento certifica la ejecuciÃ³n de la operaciÃ³n de tokenizaciÃ³n/transferencia de USD en la red Ethereum Mainnet a travÃ©s del sistema DAES. La transacciÃ³n ha sido registrada de forma inmutable en la blockchain y cumple con los estÃ¡ndares ISO 20022 e ISO 4217. Servidor RPC proporcionado por Alchemy.'
      : 'This document certifies the execution of the USD tokenization/transfer operation on Ethereum Mainnet through the DAES system. The transaction has been immutably recorded on the blockchain and complies with ISO 20022 and ISO 4217 standards. RPC server provided by Alchemy.';

    const lines = pdf.splitTextToSize(declaration, pageWidth - (margin * 2));
    pdf.text(lines, margin, y);

    // Footer
    drawInstitutionalFooter();

    // Guardar
    const filename = `DAES_ETH_USD_Receipt_${receiptNumber}`;
    pdf.save(`${filename}.pdf`);

    return filename;
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GENERAR TXT TÃ‰CNICO BLACKSCREEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const generateTechnicalTXT = (operation: MintOperation) => {
    const date = new Date(operation.timestamp);
    const custodyAccount = custodyAccounts.find(a => a.id === selectedAccountId);

    const txt = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    DIGITAL COMMERCIAL BANK LTD - BLOCKCHAIN TRANSFER                          â•‘
â•‘                         DAES - Digital Asset & Electronic Services                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Document Type: ${operation.type === 'mint' ? 'USD TOKENIZATION CERTIFICATE' : 'TOKENIZED USD TRANSFER CERTIFICATE'}
â•‘  Network: ETHEREUM MAINNET (Chain ID: 1)                                                      â•‘
â•‘  Generated: ${new Date().toISOString().padEnd(68)}â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              BLOCKCHAIN TRANSACTION DETAILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Operation ID:          ${operation.id}
  Operation Type:        ${operation.type === 'mint' ? 'TOKENIZATION (MINT)' : 'TRANSFER (SEND)'}
  Amount:                USD ${operation.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}
  Status:                ${operation.status}
  Timestamp:             ${date.toISOString()}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              BLOCKCHAIN INFORMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Network:               Ethereum Mainnet
  Chain ID:              1
  RPC Provider:          Alchemy (eth-mainnet.g.alchemy.com)
  
  Transaction Hash:      ${operation.txHash || 'Pending...'}
  Block Number:          ${operation.blockNumber || 'Pending...'}
  Gas Used:              ${operation.gasUsed || 'Standard'}
  
  Token Contract:        ${health?.contracts?.usdToken || 'N/A'}
  Bridge Minter:         ${health?.contracts?.bridgeMinter || 'N/A'}
  Registry:              ${health?.contracts?.registry || 'N/A'}

  Explorer URL:          ${operation.explorerUrl || `https://etherscan.io/tx/${operation.txHash}`}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              SOURCE CUSTODY ACCOUNT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Bank:                  DIGITAL COMMERCIAL BANK LTD
  System:                DAES CoreBanking Platform
  Account Name:          ${custodyAccount?.accountName || 'Treasury Reserve Account'}
  Account Number:        ${custodyAccount?.accountNumber || 'DCB-USD-00000001'}
  Account Type:          ${custodyAccount?.accountCategory?.toUpperCase() || 'CUSTODY'}
  Currency:              ${custodyAccount?.currency || 'USD'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              WALLET ADDRESSES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ${operation.type === 'mint' ? 'Beneficiary Wallet:' : 'From Wallet:'}    ${operation.type === 'mint' ? operation.beneficiary : operation.fromWallet || 'Treasury'}
  ${operation.type === 'send' ? `To Wallet:          ${operation.toAddress}` : ''}
  ${operation.memo ? `Memo:               ${operation.memo}` : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              DAES INTERNAL VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Validation Status:     âœ“ VERIFIED
  DAES Validation Hash:  ${Array.from({ length: 64 }, () => Math.random().toString(16).charAt(2)).join('').toUpperCase()}
  EIP-712 Signature:     VALID
  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              COMPLIANCE STANDARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ISO 20022:             pain.001.001.09 - Customer Credit Transfer
  ISO 4217:              840 - USD (United States Dollar)
  ISO 27001:             Information Security Management System
  EIP-712:               Typed Structured Data Hashing and Signing
  ERC-20:                Token Standard Compliance
  PCI-DSS:               Level 1 Certified
  AML/CFT:               FATF Compliant

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              ALCHEMY RPC SERVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Provider:              Alchemy
  Endpoint:              eth-mainnet.g.alchemy.com/v2/***
  WebSocket:             wss://eth-mainnet.g.alchemy.com/v2/***
  Current Block:         ${health?.blockNumber || 'N/A'}
  Network Status:        ${health?.success ? 'CONNECTED' : 'DISCONNECTED'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  This document certifies the execution of the blockchain operation through the DAES system.
  Transaction immutably recorded on Ethereum Mainnet.
  
  Â© ${new Date().getFullYear()} Digital Commercial Bank Ltd - DAES CoreBanking System
  All rights reserved.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

    const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DAES_ETH_USD_Statement_${operation.id}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MANEJAR MINT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const handleMint = async () => {
    if (!mintAmount || mintAmount <= 0) {
      setError(isSpanish ? 'Ingresa un monto vÃ¡lido' : 'Enter a valid amount');
      return;
    }

    if (!beneficiaryWallet || !beneficiaryWallet.startsWith('0x')) {
      setError(isSpanish ? 'Ingresa una wallet ETH vÃ¡lida (0x...)' : 'Enter a valid ETH wallet (0x...)');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      const custodyAccount = custodyAccounts.find(a => a.id === selectedAccountId);

      const result = await ethUsdClient.mintRequest({
        amountUsd: mintAmount,
        beneficiary: beneficiaryWallet,
        custodyAccountId: selectedAccountId,
        custodyAccountName: custodyAccount?.accountName,
        idempotencyKey: `mint_${Date.now()}_${Math.random().toString(36).slice(2)}`,
      });

      if (result.success) {
        setSuccess(isSpanish
          ? `âœ“ TokenizaciÃ³n exitosa! TX: ${result.txHash?.slice(0, 20)}...`
          : `âœ“ Tokenization successful! TX: ${result.txHash?.slice(0, 20)}...`);

        const op: MintOperation = {
          id: result.hold?.id || `mint_${Date.now()}`,
          type: 'mint',
          amount: mintAmount,
          beneficiary: beneficiaryWallet,
          txHash: result.txHash,
          explorerUrl: result.explorerUrl,
          status: 'COMPLETED',
          timestamp: Date.now(),
          blockNumber: result.blockNumber,
          custodyAccount,
        };

        setLastOperation(op);
        setShowReceiptModal(true);

        // Limpiar form
        setMintAmount(0);
        setBeneficiaryWallet('');

        // Recargar datos
        loadStats();
        loadOperations();
      } else {
        setError(result.error || (isSpanish ? 'Error en tokenizaciÃ³n' : 'Tokenization error'));
      }
    } catch (err: any) {
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MANEJAR SEND
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const handleSend = async () => {
    if (!sendAmount || sendAmount <= 0) {
      setError(isSpanish ? 'Ingresa un monto vÃ¡lido' : 'Enter a valid amount');
      return;
    }

    if (!sendToAddress || !sendToAddress.startsWith('0x')) {
      setError(isSpanish ? 'Ingresa una wallet destino vÃ¡lida (0x...)' : 'Enter a valid destination wallet (0x...)');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      const custodyAccount = custodyAccounts.find(a => a.id === selectedAccountId);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MINT-AND-SEND: Primero MINTEA los tokens, luego los ENVÃA directamente
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      console.log('[DAES USD UI] Iniciando MINT-AND-SEND...');
      console.log('[DAES USD UI] Cuenta custodio:', custodyAccount?.accountName);
      console.log('[DAES USD UI] Monto:', sendAmount, 'USD');
      console.log('[DAES USD UI] Destino:', sendToAddress);
      
      const result = await ethUsdClient.mintAndSend({
        amount: sendAmount,
        toAddress: sendToAddress,
        custodyAccountId: custodyAccount?.id,
        custodyAccountName: custodyAccount?.accountName,
        fromWallet: custodyAccount?.accountNumber,
        memo: sendMemo || undefined,
      });

      if (result.success) {
        setSuccess(isSpanish
          ? `âœ“ MINT-AND-SEND exitoso! TX: ${result.txHash?.slice(0, 20)}...`
          : `âœ“ MINT-AND-SEND successful! TX: ${result.txHash?.slice(0, 20)}...`);

        const op: MintOperation = {
          id: result.transfer?.id || `send_${Date.now()}`,
          type: 'send',
          amount: sendAmount,
          toAddress: sendToAddress,
          fromWallet: custodyAccount?.accountNumber,
          memo: sendMemo,
          txHash: result.txHash,
          explorerUrl: result.explorerUrl,
          status: 'COMPLETED',
          timestamp: Date.now(),
          custodyAccount,
        };

        setLastOperation(op);
        setShowReceiptModal(true);

        // Limpiar form
        setSendAmount(0);
        setSendToAddress('');
        setSendMemo('');

        // Recargar datos
        loadStats();
        loadOperations();
      } else {
        setError(result.error || (isSpanish ? 'Error en transferencia' : 'Transfer error'));
      }
    } catch (err: any) {
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#0a0a0a] via-[#111] to-[#0a0a0a] text-white p-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-purple-900/30 to-cyan-900/30 border border-purple-500/30 rounded-2xl p-6 mb-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-cyan-500 flex items-center justify-center">
              <Globe className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">
                DAES USD ALCHEMY
              </h1>
              <p className="text-gray-400">
                {isSpanish ? 'TokenizaciÃ³n USD en Ethereum Mainnet' : 'USD Tokenization on Ethereum Mainnet'}
              </p>
            </div>
          </div>

          {/* Status Badge */}
          <div className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
            health?.success
              ? 'bg-green-500/20 text-green-400 border border-green-500/30'
              : 'bg-red-500/20 text-red-400 border border-red-500/30'
          }`}>
            {health?.success ? <CheckCircle className="w-5 h-5" /> : <AlertCircle className="w-5 h-5" />}
            <span className="font-mono text-sm">
              {health?.success ? `Block ${(health?.blockNumber || 0).toLocaleString()}` : 'Offline'}
            </span>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-4 gap-4 mt-6">
          <div className="bg-black/30 rounded-xl p-4 text-center">
            <div className="text-2xl font-bold text-purple-400">{stats.total}</div>
            <div className="text-xs text-gray-500">Total</div>
          </div>
          <div className="bg-black/30 rounded-xl p-4 text-center">
            <div className="text-2xl font-bold text-green-400">{stats.completed}</div>
            <div className="text-xs text-gray-500">{isSpanish ? 'Completados' : 'Completed'}</div>
          </div>
          <div className="bg-black/30 rounded-xl p-4 text-center">
            <div className="text-2xl font-bold text-cyan-400">${(stats?.totalMinted || 0).toLocaleString()}</div>
            <div className="text-xs text-gray-500">Total USD</div>
          </div>
          <div className="bg-black/30 rounded-xl p-4 text-center">
            <div className="text-2xl font-bold text-yellow-400">{stats.pending}</div>
            <div className="text-xs text-gray-500">{isSpanish ? 'Pendientes' : 'Pending'}</div>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-6 p-1 bg-[#111] rounded-xl border border-gray-800">
        {[
          { id: 'mint', icon: Coins, label: isSpanish ? 'Tokenizar' : 'Tokenize', gradient: 'from-yellow-500 to-orange-500' },
          { id: 'send', icon: Send, label: isSpanish ? 'Enviar' : 'Send', gradient: 'from-blue-500 to-cyan-500' },
          { id: 'history', icon: History, label: isSpanish ? 'Historial' : 'History', gradient: 'from-purple-500 to-pink-500' },
          { id: 'config', icon: Server, label: 'Config', gradient: 'from-gray-500 to-gray-600' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id as any)}
            className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-all ${
              activeTab === tab.id
                ? `bg-gradient-to-r ${tab.gradient} text-white`
                : 'text-gray-400 hover:bg-gray-800'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Alerts */}
      {error && (
        <div className="mb-4 p-4 bg-red-500/20 border border-red-500/50 rounded-xl flex items-center gap-3 text-red-400">
          <AlertCircle className="w-5 h-5" />
          {error}
          <button onClick={() => setError(null)} className="ml-auto hover:text-red-300">âœ•</button>
        </div>
      )}

      {success && (
        <div className="mb-4 p-4 bg-green-500/20 border border-green-500/50 rounded-xl flex items-center gap-3 text-green-400">
          <CheckCircle className="w-5 h-5" />
          {success}
          <button onClick={() => setSuccess(null)} className="ml-auto hover:text-green-300">âœ•</button>
        </div>
      )}

      {/* Content */}
      <div className="bg-[#111] border border-gray-800 rounded-2xl p-6">
        {/* MINT TAB */}
        {activeTab === 'mint' && (
          <div className="space-y-6">
            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Cuenta Origen (Custody USD)' : 'Source Account (Custody USD)'}
              </label>
              <select
                value={selectedAccountId}
                onChange={(e) => setSelectedAccountId(e.target.value)}
                className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white"
              >
                <option value="">{isSpanish ? 'Seleccionar cuenta...' : 'Select account...'}</option>
                {custodyAccounts.map(acc => (
                  <option key={acc.id} value={acc.id}>
                    {acc.accountName} - {acc.currency} {(acc?.availableBalance || 0).toLocaleString()}
                  </option>
                ))}
              </select>
            </div>

            {/* Balance Card - Shows when account is selected */}
            {selectedAccountId && (() => {
              const selectedAccount = custodyAccounts.find(a => a.id === selectedAccountId);
              if (!selectedAccount) return null;
              const balance = typeof selectedAccount.availableBalance === 'number' ? selectedAccount.availableBalance : 0;
              return (
                <div className="p-5 bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-xl border border-green-500/30">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="p-3 rounded-full bg-green-500/20">
                        <Coins className="w-7 h-7 text-green-400" />
                      </div>
                      <div>
                        <div className="text-sm text-gray-400">
                          {isSpanish ? 'Balance Disponible' : 'Available Balance'}
                        </div>
                        <div className="text-3xl font-bold text-green-400">
                          ${balance.toLocaleString()}
                        </div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-sm text-gray-400">{selectedAccount.accountName || 'N/A'}</div>
                      <div className="text-xs text-gray-500 font-mono">{selectedAccount.accountNumber || 'N/A'}</div>
                      <div className="text-xs text-gray-500">{selectedAccount.bankName || ''}</div>
                    </div>
                  </div>
                </div>
              );
            })()}

            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Monto a Tokenizar' : 'Amount to Tokenize'}
              </label>
              <div className="relative">
                <input
                  type="number"
                  value={mintAmount || ''}
                  onChange={(e) => setMintAmount(parseFloat(e.target.value) || 0)}
                  placeholder="0.00"
                  className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white text-xl font-mono"
                />
                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-yellow-400 font-bold">USD</span>
              </div>
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Wallet Beneficiario (ETH Mainnet)' : 'Beneficiary Wallet (ETH Mainnet)'}
              </label>
              <div className="relative">
                <input
                  type="text"
                  value={beneficiaryWallet}
                  onChange={(e) => setBeneficiaryWallet(e.target.value)}
                  placeholder="0x..."
                  className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white font-mono"
                />
                <Wallet className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-purple-400" />
              </div>
            </div>

            <button
              onClick={handleMint}
              disabled={isLoading || !mintAmount || !beneficiaryWallet}
              className="w-full py-4 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl font-bold text-black flex items-center justify-center gap-2 hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            >
              {isLoading ? (
                <RefreshCw className="w-5 h-5 animate-spin" />
              ) : (
                <Coins className="w-5 h-5" />
              )}
              {isSpanish ? 'Tokenizar USD' : 'Tokenize USD'}
            </button>
          </div>
        )}

        {/* SEND TAB */}
        {activeTab === 'send' && (
          <div className="space-y-6">
            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Cuenta Origen' : 'Source Account'}
              </label>
              <select
                value={selectedAccountId}
                onChange={(e) => setSelectedAccountId(e.target.value)}
                className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white"
              >
                <option value="">{isSpanish ? 'Seleccionar cuenta...' : 'Select account...'}</option>
                {custodyAccounts.map(acc => (
                  <option key={acc.id} value={acc.id}>
                    {acc.accountName} - {acc.currency} {(acc?.availableBalance || 0).toLocaleString()}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Monto a Enviar' : 'Amount to Send'}
              </label>
              <div className="relative">
                <input
                  type="number"
                  value={sendAmount || ''}
                  onChange={(e) => setSendAmount(parseFloat(e.target.value) || 0)}
                  placeholder="0.00"
                  className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white text-xl font-mono"
                />
                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-cyan-400 font-bold">USD</span>
              </div>
            </div>

            {/* RECEIVER SELECTOR */}
            <div className="p-4 bg-gradient-to-br from-purple-900/30 to-indigo-900/30 rounded-xl border border-purple-500/30">
              <label className="block text-sm text-purple-300 mb-3 flex items-center gap-2">
                <Building2 className="w-4 h-4" />
                {isSpanish ? 'Seleccionar Receiver Configurado' : 'Select Configured Receiver'}
              </label>
              <div className="space-y-2">
                {PREDEFINED_RECEIVERS.map(receiver => (
                  <button
                    key={receiver.id}
                    type="button"
                    onClick={() => {
                      setSelectedReceiver(receiver);
                      setSendToAddress(receiver.address);
                    }}
                    className={`w-full p-4 rounded-xl border text-left transition-all ${
                      selectedReceiver?.id === receiver.id
                        ? 'bg-purple-500/20 border-purple-500 text-white'
                        : 'bg-black/30 border-gray-700 text-gray-300 hover:border-purple-400'
                    }`}
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1">
                        <div className="font-bold text-white flex items-center gap-2">
                          {receiver.name}
                          {selectedReceiver?.id === receiver.id && (
                            <CheckCircle className="w-4 h-4 text-green-400" />
                          )}
                        </div>
                        <div className="text-xs text-purple-300 font-mono mt-1">
                          {receiver.address}
                        </div>
                        {receiver.company && (
                          <div className="text-xs text-gray-400 mt-1">{receiver.company}</div>
                        )}
                        {receiver.registrationNumber && (
                          <div className="text-xs text-gray-500">Reg: {receiver.registrationNumber}</div>
                        )}
                      </div>
                      <ExternalLink className="w-4 h-4 text-purple-400 flex-shrink-0" />
                    </div>
                  </button>
                ))}
              </div>
              {selectedReceiver && (
                <div className="mt-4 p-3 bg-purple-500/10 rounded-lg border border-purple-500/20">
                  <div className="text-xs text-purple-300 font-medium mb-2">{isSpanish ? 'Detalles del Receiver:' : 'Receiver Details:'}</div>
                  <div className="space-y-1 text-xs">
                    {selectedReceiver.hostAddress && (
                      <div className="text-gray-400">Host: {selectedReceiver.hostAddress}</div>
                    )}
                    {selectedReceiver.hostIP && (
                      <div className="text-gray-400">IP: {selectedReceiver.hostIP}</div>
                    )}
                    {selectedReceiver.representative && (
                      <div className="text-gray-400">Rep: {selectedReceiver.representative}</div>
                    )}
                    {selectedReceiver.country && (
                      <div className="text-gray-400">{isSpanish ? 'PaÃ­s' : 'Country'}: {selectedReceiver.country}</div>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div className="text-center text-gray-500 text-sm py-2">
              {isSpanish ? 'â€” O ingresa direcciÃ³n manualmente â€”' : 'â€” Or enter address manually â€”'}
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Wallet Destino (ETH Mainnet)' : 'Destination Wallet (ETH Mainnet)'}
              </label>
              <div className="relative">
                <input
                  type="text"
                  value={sendToAddress}
                  onChange={(e) => setSendToAddress(e.target.value)}
                  placeholder="0x..."
                  className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white font-mono"
                />
                <Send className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-cyan-400" />
              </div>
            </div>

            <div>
              <label className="block text-sm text-gray-400 mb-2">
                {isSpanish ? 'Memo (Opcional)' : 'Memo (Optional)'}
              </label>
              <input
                type="text"
                value={sendMemo}
                onChange={(e) => setSendMemo(e.target.value)}
                placeholder={isSpanish ? 'Referencia o nota...' : 'Reference or note...'}
                className="w-full bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white"
              />
            </div>

            <button
              onClick={handleSend}
              disabled={isLoading || !sendAmount || !sendToAddress}
              className="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl font-bold text-white flex items-center justify-center gap-2 hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            >
              {isLoading ? (
                <RefreshCw className="w-5 h-5 animate-spin" />
              ) : (
                <Send className="w-5 h-5" />
              )}
              {isSpanish ? 'Enviar USD Tokenizado' : 'Send Tokenized USD'}
            </button>
          </div>
        )}

        {/* HISTORY TAB */}
        {activeTab === 'history' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold text-gray-200">
                {isSpanish ? 'Historial de Operaciones' : 'Operation History'}
              </h3>
              <button
                onClick={() => { loadOperations(); loadStats(); }}
                className="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"
              >
                <RefreshCw className="w-5 h-5 text-gray-400" />
              </button>
            </div>

            {operations.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <History className="w-12 h-12 mx-auto mb-4 opacity-50" />
                <p>{isSpanish ? 'No hay operaciones registradas' : 'No operations recorded'}</p>
              </div>
            ) : (
              <div className="space-y-3">
                {operations.map((op) => (
                  <div
                    key={op.id}
                    className={`p-4 bg-black/30 border rounded-xl transition-all ${
                      op.type === 'mint' ? 'border-yellow-500/30 hover:border-yellow-500/50' : 'border-cyan-500/30 hover:border-cyan-500/50'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                          op.type === 'mint' ? 'bg-yellow-500/20' : 'bg-cyan-500/20'
                        }`}>
                          {op.type === 'mint' ? (
                            <Coins className="w-5 h-5 text-yellow-400" />
                          ) : (
                            <Send className="w-5 h-5 text-cyan-400" />
                          )}
                        </div>
                        <div>
                          <div className="font-medium text-white">
                            {op.type === 'mint' ? 'Tokenization' : 'Transfer'} - ${op.amount.toLocaleString()}
                          </div>
                          <div className="text-xs text-gray-500">
                            {new Date(op.timestamp).toLocaleString()}
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-1 rounded text-xs font-mono ${
                          op.status === 'COMPLETED' ? 'bg-green-500/20 text-green-400' :
                          op.status === 'PENDING' ? 'bg-yellow-500/20 text-yellow-400' :
                          'bg-red-500/20 text-red-400'
                        }`}>
                          {op.status}
                        </span>

                        {op.txHash && (
                          <a
                            href={op.explorerUrl || `https://etherscan.io/tx/${op.txHash}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"
                            title="View on Etherscan"
                          >
                            <ExternalLink className="w-4 h-4 text-purple-400" />
                          </a>
                        )}

                        <button
                          onClick={() => {
                            setLastOperation(op);
                            generateBlockchainReceiptPDF(op);
                          }}
                          className="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"
                          title={isSpanish ? 'Descargar PDF' : 'Download PDF'}
                        >
                          <Download className="w-4 h-4 text-green-400" />
                        </button>

                        <button
                          onClick={() => generateTechnicalTXT(op)}
                          className="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"
                          title={isSpanish ? 'Descargar TXT' : 'Download TXT'}
                        >
                          <FileText className="w-4 h-4 text-blue-400" />
                        </button>
                      </div>
                    </div>

                    {/* TX Hash */}
                    {op.txHash && (
                      <div className="mt-3 pt-3 border-t border-gray-800">
                        <div className="flex items-center gap-2 text-xs">
                          <Hash className="w-3 h-3 text-purple-400" />
                          <span className="text-gray-500">TX:</span>
                          <code className="text-purple-400 font-mono">{op.txHash.slice(0, 20)}...{op.txHash.slice(-8)}</code>
                          <button
                            onClick={() => navigator.clipboard.writeText(op.txHash)}
                            className="p-1 hover:bg-gray-800 rounded"
                          >
                            <Copy className="w-3 h-3 text-gray-500" />
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* CONFIG TAB */}
        {activeTab === 'config' && (
          <div className="space-y-6">
            {/* System Status */}
            <div className="bg-black/30 rounded-xl p-6 border border-gray-800">
              <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                <Server className="w-5 h-5 text-purple-400" />
                {isSpanish ? 'Estado del Sistema' : 'System Status'}
              </h3>

              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">Network</div>
                  <div className="text-lg font-mono text-purple-400">{health?.network?.name || 'Ethereum Mainnet'}</div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">Chain ID</div>
                  <div className="text-lg font-mono text-cyan-400">{health?.chainId || 1}</div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">Current Block</div>
                  <div className="text-lg font-mono text-green-400">{health?.blockNumber?.toLocaleString() || '-'}</div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">RPC Provider</div>
                  <div className="text-lg font-mono text-yellow-400">Alchemy</div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">WebSocket</div>
                  <div className={`text-lg font-mono ${health?.wsConnected ? 'text-green-400' : 'text-yellow-400'}`}>
                    {health?.wsConnected ? 'â— Connected' : 'â—‹ Disconnected'}
                  </div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="text-xs text-gray-500 mb-1">Host IP (Whitelist)</div>
                  <div className="text-lg font-mono text-gray-400">161.35.181.101</div>
                </div>
              </div>
            </div>

            {/* Master Wallet */}
            <div className="bg-gradient-to-r from-purple-900/30 to-cyan-900/30 rounded-xl p-6 border border-purple-500/30">
              <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                <Wallet className="w-5 h-5 text-yellow-400" />
                Master Wallet (Receiver)
              </h3>

              <div className="p-4 bg-black/50 rounded-lg border border-yellow-500/30">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-xs text-gray-500">ETH Master Wallet Address</div>
                  <div className="flex items-center gap-2">
                    <span className="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">RECEIVER</span>
                    <button
                      onClick={() => navigator.clipboard.writeText(health?.masterWallet || '0x1c01919cf117fb26b57554bc6bcec487e6831364')}
                      className="p-1 hover:bg-gray-800 rounded"
                      title="Copy address"
                    >
                      <Copy className="w-4 h-4 text-gray-500" />
                    </button>
                  </div>
                </div>
                <code className="text-lg text-yellow-400 font-mono break-all">
                  {health?.masterWallet || '0x1c01919cf117fb26b57554bc6bcec487e6831364'}
                </code>
                <div className="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-500">
                  {isSpanish 
                    ? 'Esta wallet es la receptora final para todas las transacciones originadas desde DAES.'
                    : 'This wallet is the final receiver for all transactions originated from DAES.'}
                </div>
              </div>
            </div>

            {/* Alchemy Endpoints */}
            <div className="bg-black/30 rounded-xl p-6 border border-gray-800">
              <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                <Globe className="w-5 h-5 text-blue-400" />
                Alchemy RPC Endpoints
              </h3>

              <div className="space-y-3">
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-gray-500">RPC Endpoint (HTTPS)</div>
                    <span className="text-xs text-green-400">â— Active</span>
                  </div>
                  <code className="text-sm text-blue-400 font-mono break-all">
                    https://eth-mainnet.g.alchemy.com/v2/7iQ1...YqJ
                  </code>
                  <div className="text-xs text-gray-600 mt-1">
                    {isSpanish ? 'EnvÃ­o de transacciones, consultas de estado, balances' : 'Transaction sending, state queries, balances'}
                  </div>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-gray-500">WebSocket Endpoint (WSS)</div>
                    <span className={`text-xs ${health?.wsConnected ? 'text-green-400' : 'text-yellow-400'}`}>
                      {health?.wsConnected ? 'â— Connected' : 'â—‹ Standby'}
                    </span>
                  </div>
                  <code className="text-sm text-purple-400 font-mono break-all">
                    wss://eth-mainnet.g.alchemy.com/v2/7iQ1...YqJ
                  </code>
                  <div className="text-xs text-gray-600 mt-1">
                    {isSpanish ? 'Confirmaciones en tiempo real, tracking de TX' : 'Real-time confirmations, TX tracking'}
                  </div>
                </div>
              </div>
            </div>

            {/* Deployed Contracts */}
            <div className="bg-black/30 rounded-xl p-6 border border-gray-800">
              <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                <Shield className="w-5 h-5 text-green-400" />
                {isSpanish ? 'Contratos Desplegados' : 'Deployed Contracts'}
              </h3>

              <div className="space-y-3">
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-gray-500">USD Token (ERC-20, 6 decimals)</div>
                    <a 
                      href={`https://etherscan.io/address/${health?.contracts?.usdToken || '0x3db99FACe6BB270E86BCA3355655dB747867f67b'}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1"
                    >
                      <ExternalLink className="w-3 h-3" />
                      Etherscan
                    </a>
                  </div>
                  <code className="text-sm text-purple-400 font-mono break-all">
                    {health?.contracts?.usdToken || '0x3db99FACe6BB270E86BCA3355655dB747867f67b'}
                  </code>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-gray-500">Settlement Registry</div>
                    <a 
                      href={`https://etherscan.io/address/${health?.contracts?.registry || '0x346bBC9976AE540896125B01e14E8bc7Ef1EDB32'}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-xs text-cyan-400 hover:text-cyan-300 flex items-center gap-1"
                    >
                      <ExternalLink className="w-3 h-3" />
                      Etherscan
                    </a>
                  </div>
                  <code className="text-sm text-cyan-400 font-mono break-all">
                    {health?.contracts?.registry || '0x346bBC9976AE540896125B01e14E8bc7Ef1EDB32'}
                  </code>
                </div>
                <div className="p-4 bg-black/50 rounded-lg">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-gray-500">Bridge Minter (EIP-712)</div>
                    <a 
                      href={`https://etherscan.io/address/${health?.contracts?.bridgeMinter || '0xa2969f87E9C5C6996aC7E7fFC36C35A8ba178A03'}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-xs text-yellow-400 hover:text-yellow-300 flex items-center gap-1"
                    >
                      <ExternalLink className="w-3 h-3" />
                      Etherscan
                    </a>
                  </div>
                  <code className="text-sm text-yellow-400 font-mono break-all">
                    {health?.contracts?.bridgeMinter || '0xa2969f87E9C5C6996aC7E7fFC36C35A8ba178A03'}
                  </code>
                </div>
              </div>
            </div>

            <div className="bg-black/30 rounded-xl p-6 border border-gray-800">
              <h3 className="text-lg font-bold text-gray-200 mb-4 flex items-center gap-2">
                <Database className="w-5 h-5 text-blue-400" />
                {isSpanish ? 'EstÃ¡ndares de Cumplimiento' : 'Compliance Standards'}
              </h3>

              <div className="grid grid-cols-3 gap-3">
                {[
                  { name: 'ISO 20022', desc: 'Payment Messages' },
                  { name: 'ISO 4217', desc: 'Currency Codes' },
                  { name: 'ISO 27001', desc: 'Security' },
                  { name: 'EIP-712', desc: 'Typed Signing' },
                  { name: 'ERC-20', desc: 'Token Standard' },
                  { name: 'PCI-DSS', desc: 'Payment Security' },
                ].map(std => (
                  <div key={std.name} className="p-3 bg-black/50 rounded-lg text-center">
                    <div className="text-sm font-bold text-green-400">{std.name}</div>
                    <div className="text-xs text-gray-500">{std.desc}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Info Footer */}
      <div className="mt-6 p-4 bg-black/30 border border-gray-800 rounded-xl flex items-center gap-3">
        <Activity className="w-5 h-5 text-purple-400" />
        <div className="text-sm text-gray-400">
          <strong className="text-white">Network:</strong> Ethereum Mainnet (Chain ID: 1) |{' '}
          <strong className="text-white">ISO 4217:</strong> USD (840)
        </div>
      </div>

      {/* Receipt Modal */}
      {showReceiptModal && lastOperation && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div className="bg-[#111] border border-gray-700 rounded-2xl p-6 max-w-lg w-full">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold flex items-center gap-2">
                <Receipt className="w-6 h-6 text-green-400" />
                {isSpanish ? 'OperaciÃ³n Exitosa' : 'Operation Successful'}
              </h2>
              <button
                onClick={() => setShowReceiptModal(false)}
                className="p-2 hover:bg-gray-800 rounded-lg"
              >
                âœ•
              </button>
            </div>

            <div className="space-y-4">
              <div className="p-4 bg-green-500/20 border border-green-500/30 rounded-xl">
                <div className="text-center">
                  <CheckCircle className="w-12 h-12 text-green-400 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-white">
                    ${(lastOperation?.amount || 0).toLocaleString()} USD
                  </div>
                  <div className="text-sm text-green-400">
                    {lastOperation.type === 'mint' ? 'Tokenized' : 'Transferred'} Successfully
                  </div>
                </div>
              </div>

              {lastOperation.txHash && (
                <div className="p-4 bg-black/50 rounded-xl">
                  <div className="text-xs text-gray-500 mb-1">Transaction Hash</div>
                  <code className="text-sm text-purple-400 font-mono break-all">
                    {lastOperation.txHash}
                  </code>
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => generateBlockchainReceiptPDF(lastOperation)}
                  className="flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl font-bold text-white flex items-center justify-center gap-2 hover:opacity-90"
                >
                  <Download className="w-5 h-5" />
                  {isSpanish ? 'Descargar PDF' : 'Download PDF'}
                </button>
                <button
                  onClick={() => generateTechnicalTXT(lastOperation)}
                  className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl font-bold text-white flex items-center justify-center gap-2 hover:opacity-90"
                >
                  <FileText className="w-5 h-5" />
                  {isSpanish ? 'Descargar TXT' : 'Download TXT'}
                </button>
              </div>

              {lastOperation.explorerUrl && (
                <a
                  href={lastOperation.explorerUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="block w-full py-3 bg-purple-600/20 border border-purple-500/30 rounded-xl font-medium text-purple-400 text-center hover:bg-purple-600/30 transition-colors"
                >
                  <ExternalLink className="w-4 h-4 inline mr-2" />
                  {isSpanish ? 'Ver en Etherscan' : 'View on Etherscan'}
                </a>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
